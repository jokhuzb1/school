generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id                  String   @id @default(uuid())
  name                String
  address             String?
  phone               String?
  email               String?
  webhookSecretIn     String   @default(uuid())
  webhookSecretOut    String   @default(uuid())
  lateThresholdMinutes Int     @default(15)
  absenceCutoffMinutes Int     @default(180)
  timezone            String   @default("Asia/Tashkent")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  users               User[]
  classes             Class[]
  students            Student[]
  devices             Device[]
  attendanceEvents    AttendanceEvent[]
  dailyAttendances    DailyAttendance[]
  holidays            Holiday[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(SCHOOL_ADMIN)
  schoolId  String?
  school    School?  @relation(fields: [schoolId], references: [id])

  // TEACHER -> Class assignment
  teacherClasses TeacherClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([role])
}

enum Role {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  GUARD
}

model TeacherClass {
  id        String @id @default(uuid())
  teacherId String
  classId   String

  teacher   User   @relation(fields: [teacherId], references: [id])
  class     Class  @relation(fields: [classId], references: [id])

  @@unique([teacherId, classId])
  @@index([teacherId])
  @@index([classId])
}


model Class {
  id         String   @id @default(uuid())
  name       String
  gradeLevel Int
  schoolId   String
  school     School   @relation(fields: [schoolId], references: [id])
  startTime  String
  endTime    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  students   Student[]

  teacherClasses TeacherClass[]

  @@index([schoolId])
  @@index([schoolId, gradeLevel])
}

model Student {
  id                 String   @id @default(uuid())
  deviceStudentId    String?  // the ID registered in Hikvision device
  name               String
  schoolId           String
  school             School   @relation(fields: [schoolId], references: [id])
  classId            String?
  class              Class?   @relation(fields: [classId], references: [id])
  parentPhone        String?
  parentName         String?
  photoUrl           String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  attendanceEvents   AttendanceEvent[]
  dailyAttendances   DailyAttendance[]

  @@index([schoolId])
  @@index([schoolId, isActive])
  @@index([classId])
  @@index([deviceStudentId])  // Webhook lookup uchun KRITIK
  @@index([schoolId, classId, isActive])
  @@unique([schoolId, deviceStudentId])
}

model Device {
  id         String   @id @default(uuid())
  name       String
  deviceId   String   @unique
  schoolId   String
  school     School   @relation(fields: [schoolId], references: [id])
  type       DeviceType
  location   String?
  isActive   Boolean  @default(true)
  lastSeenAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  attendanceEvents AttendanceEvent[]

  @@index([schoolId])
  @@index([schoolId, isActive])
  @@index([deviceId, schoolId])  // Webhook verification uchun
}

enum DeviceType {
  ENTRANCE
  EXIT
}

model AttendanceEvent {
  id         String   @id @default(uuid())
  eventKey   String   @unique
  studentId  String?
  student    Student? @relation(fields: [studentId], references: [id])
  schoolId   String
  school     School   @relation(fields: [schoolId], references: [id])
  deviceId   String?
  device     Device?  @relation(fields: [deviceId], references: [id])
  eventType  EventType
  timestamp  DateTime
  rawPayload Json
  createdAt  DateTime @default(now())

  @@index([schoolId])
  @@index([schoolId, timestamp])
  @@index([studentId])
  @@index([studentId, timestamp])
  @@index([timestamp])
  @@index([schoolId, eventType, timestamp])
}

enum EventType {
  IN
  OUT
}

model DailyAttendance {
  id                  String   @id @default(uuid())
  studentId           String
  student             Student  @relation(fields: [studentId], references: [id])
  schoolId            String
  school              School   @relation(fields: [schoolId], references: [id])
  date                DateTime
  status              AttendanceStatus
  firstScanTime       DateTime?
  lastScanTime        DateTime?
  lateMinutes         Int?
  totalTimeOnPremises Int?      // Jami maktabda bo'lgan vaqt (daqiqalarda)
  notes               String?
  
  // Yangi fieldlar - IN/OUT tracking uchun
  lastInTime          DateTime? // Oxirgi KIRISH vaqti
  lastOutTime         DateTime? // Oxirgi CHIQISH vaqti
  currentlyInSchool   Boolean   @default(false) // Hozir maktabdami?
  scanCount           Int       @default(0) // Jami scan soni
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([studentId, date])
  @@index([schoolId])
  @@index([schoolId, date])
  @@index([schoolId, date, status])
  @@index([date])
  @@index([date, currentlyInSchool])
  @@index([schoolId, currentlyInSchool])
  @@index([studentId])
  @@index([status])
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

model Holiday {
  id        String   @id @default(uuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  date      DateTime
  name      String
  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([schoolId, date])
  @@index([date])
}
